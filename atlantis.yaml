# version: 3
# projects:
#   - dir: aws/dev
#     workflow: dev
#     autoplan:
#       when_modified: ["terraform/dev/**/*.tf"]
#   - dir: aws/stage
#     workflow: stage
#     autoplan:
#       when_modified: ["terraform/stage/**/*.tf"]

---
version: 3
automerge: true
delete_source_branch_on_merge: true

projects:
- name: project-dev
  dir: terraform/dev
  terraform_version: 1.2.9
  workflow: default
  autoplan:
    when_modified:
    - '**/*.tf'

- name: project-stage
  dir: terraform/stage
  terraform_version: 1.2.9
  workflow: default
  autoplan:
    when_modified:
    - '**/*.tf'

workflows:
  default:
    plan:
      steps:
        - run: echo hi
        - run: |
            temp_role=$(aws sts assume-role --role-arn arn:aws:iam::838747702413:role/atlantis_dev --role-session-name AtlantisSession)
            export AWS_ACCESS_KEY_ID=$(echo $temp_role | jq -r .Credentials.AccessKeyId)
            export AWS_SECRET_ACCESS_KEY=$(echo $temp_role | jq -r .Credentials.SecretAccessKey)
            export AWS_SESSION_TOKEN=$(echo $temp_role | jq -r .Credentials.SessionToken)
        - env:
            name: TEMP_CREDS
            command: aws sts assume-role --role-arn arn:aws:iam::838747702413:role/atlantis_dev --role-session-name AtlantisSession
        - env:
            name: AWS_ACCESS_KEY_ID
            command: echo $TEMP_CREDS | jq -r .Credentials.AccessKeyId
        - env:
            name: AWS_SECRET_ACCESS_KEY
            command: echo $TEMP_CREDS | jq -r .Credentials.SecretAccessKey
        - env:
            name: AWS_SESSION_TOKEN
            command: echo $TEMP_CREDS | jq -r .Credentials.SessionToken
        - run: echo $AWS_ACCESS_KEY_ID
        - run: echo $AWS_SECRET_ACCESS_KEY
        - run: echo $AWS_SESSION_TOKEN
        - init
        - plan
    apply:
      steps:
        - apply
