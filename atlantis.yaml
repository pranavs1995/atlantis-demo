---
version: 3
automerge: true
delete_source_branch_on_merge: true

projects:
- name: project-dev
  dir: terraform/dev
  terraform_version: 1.2.9
  workflow: dev
  autoplan:
    when_modified:
    - '**/*.tf'

- name: project-stage
  dir: terraform/stage
  terraform_version: 1.2.9
  workflow: stage
  autoplan:
    when_modified:
    - '**/*.tf'

workflows:
  dev:
    plan:
      steps:
        - env:
            name: TEMP_CREDS
            command: aws sts assume-role --role-arn arn:aws:iam::838747702413:role/atlantis_dev --role-session-name AtlantisSession
        - env:
            name: AWS_ACCESS_KEY_ID
            command: echo $TEMP_CREDS | jq -r .Credentials.AccessKeyId
        - env:
            name: AWS_SECRET_ACCESS_KEY
            command: echo $TEMP_CREDS | jq -r .Credentials.SecretAccessKey
        - env:
            name: AWS_SESSION_TOKEN
            command: echo $TEMP_CREDS | jq -r .Credentials.SessionToken
        - init
        - plan
    apply:
      steps:
        - apply

  stage:
    plan:
      steps:
        - env:
            name: TEMP_CREDS
            command: aws sts assume-role --role-arn arn:aws:iam::838747702413:role/atlantis_stage --role-session-name AtlantisSession
        - env:
            name: AWS_ACCESS_KEY_ID
            command: echo $TEMP_CREDS | jq -r .Credentials.AccessKeyId
        - env:
            name: AWS_SECRET_ACCESS_KEY
            command: echo $TEMP_CREDS | jq -r .Credentials.SecretAccessKey
        - env:
            name: AWS_SESSION_TOKEN
            command: echo $TEMP_CREDS | jq -r .Credentials.SessionToken
        - init
        - plan
    apply:
      steps:
        - apply